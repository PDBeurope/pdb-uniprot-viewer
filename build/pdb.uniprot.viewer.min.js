/**
 * PDB Sequence Viewer
 * @version v1.0.0
 * @link https://github.com/mandarsd/pdb-sequence-viewer
 * @license Apache 2.0
 */
/**
 * Copyright 2015-2016 Mandar Deshpande <mandar@ebi.ac.uk>
 * European Bioinformatics Institute (EBI, http://www.ebi.ac.uk/)
 * European Molecular Biology Laboratory (EMBL, http://www.embl.de/)
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and 
 * limitations under the License.
 */
(function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function e(t){return"function"==typeof t}function n(t){W=t}function i(t){N=t}function o(){return function(){process.nextTick(l)}}function r(){return function(){Z(l)}}function a(){var t=0,e=new K(l),n=document.createTextNode("");return e.observe(n,{characterData:!0}),function(){n.data=t=++t%2}}function s(){var t=new MessageChannel;return t.port1.onmessage=l,function(){t.port2.postMessage(0)}}function p(){return function(){setTimeout(l,1)}}function l(){for(var t=0;$>t;t+=2){var e=te[t],n=te[t+1];e(n),te[t]=void 0,te[t+1]=void 0}$=0}function u(){try{var t=require,e=t("vertx");return Z=e.runOnLoop||e.runOnContext,r()}catch(n){return p()}}function c(t,e){var n=this,i=new this.constructor(h);void 0===i[ie]&&k(i);var o=n._state;if(o){var r=arguments[o-1];N(function(){I(o,i,r,n._result)})}else M(n,i,t,e);return i}function d(t){var e=this;if(t&&"object"==typeof t&&t.constructor===e)return t;var n=new e(h);return x(n,t),n}function h(){}function f(){return new TypeError("You cannot resolve a promise with itself")}function g(){return new TypeError("A promises callback cannot return that same promise.")}function m(t){try{return t.then}catch(e){return se.error=e,se}}function v(t,e,n,i){try{t.call(e,n,i)}catch(o){return o}}function b(t,e,n){N(function(t){var i=!1,o=v(n,e,function(n){i||(i=!0,e!==n?x(t,n):_(t,n))},function(e){i||(i=!0,P(t,e))},"Settle: "+(t._label||" unknown promise"));!i&&o&&(i=!0,P(t,o))},t)}function w(t,e){e._state===re?_(t,e._result):e._state===ae?P(t,e._result):M(e,void 0,function(e){x(t,e)},function(e){P(t,e)})}function y(t,n,i){n.constructor===t.constructor&&i===ee&&constructor.resolve===ne?w(t,n):i===se?P(t,se.error):void 0===i?_(t,n):e(i)?b(t,n,i):_(t,n)}function x(e,n){e===n?P(e,f()):t(n)?y(e,n,m(n)):_(e,n)}function S(t){t._onerror&&t._onerror(t._result),C(t)}function _(t,e){t._state===oe&&(t._result=e,t._state=re,0!==t._subscribers.length&&N(C,t))}function P(t,e){t._state===oe&&(t._state=ae,t._result=e,N(S,t))}function M(t,e,n,i){var o=t._subscribers,r=o.length;t._onerror=null,o[r]=e,o[r+re]=n,o[r+ae]=i,0===r&&t._state&&N(C,t)}function C(t){var e=t._subscribers,n=t._state;if(0!==e.length){for(var i,o,r=t._result,a=0;a<e.length;a+=3)i=e[a],o=e[a+n],i?I(n,i,o,r):o(r);t._subscribers.length=0}}function A(){this.error=null}function D(t,e){try{return t(e)}catch(n){return pe.error=n,pe}}function I(t,n,i,o){var r,a,s,p,l=e(i);if(l){if(r=D(i,o),r===pe?(p=!0,a=r.error,r=null):s=!0,n===r)return void P(n,g())}else r=o,s=!0;n._state!==oe||(l&&s?x(n,r):p?P(n,a):t===re?_(n,r):t===ae&&P(n,r))}function q(t,e){try{e(function(e){x(t,e)},function(e){P(t,e)})}catch(n){P(t,n)}}function T(){return le++}function k(t){t[ie]=le++,t._state=void 0,t._result=void 0,t._subscribers=[]}function E(t){return new fe(this,t).promise}function L(t){var e=this;return new e(j(t)?function(n,i){for(var o=t.length,r=0;o>r;r++)e.resolve(t[r]).then(n,i)}:function(t,e){e(new TypeError("You must pass an array to race."))})}function G(t){var e=this,n=new e(h);return P(n,t),n}function B(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function V(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function z(t){this[ie]=T(),this._result=this._state=void 0,this._subscribers=[],h!==t&&("function"!=typeof t&&B(),this instanceof z?q(this,t):V())}function R(t,e){this._instanceConstructor=t,this.promise=new t(h),this.promise[ie]||k(this.promise),Array.isArray(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._result=new Array(this.length),0===this.length?_(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&_(this.promise,this._result))):P(this.promise,U())}function U(){return new Error("Array Methods must be provided an Array")}function O(){var t;if("undefined"!=typeof global)t=global;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=t.Promise;(!n||"[object Promise]"!==Object.prototype.toString.call(n.resolve())||n.cast)&&(t.Promise=he)}var F;F=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var Z,W,H,j=F,$=0,N=function(t,e){te[$]=t,te[$+1]=e,$+=2,2===$&&(W?W(l):H())},Y="undefined"!=typeof window?window:void 0,X=Y||{},K=X.MutationObserver||X.WebKitMutationObserver,J="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Q="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,te=new Array(1e3);H=J?o():K?a():Q?s():void 0===Y&&"function"==typeof require?u():p();var ee=c,ne=d,ie=Math.random().toString(36).substring(16),oe=void 0,re=1,ae=2,se=new A,pe=new A,le=0,ue=E,ce=L,de=G,he=z;z.all=ue,z.race=ce,z.resolve=ne,z.reject=de,z._setScheduler=n,z._setAsap=i,z._asap=N,z.prototype={constructor:z,then:ee,"catch":function(t){return this.then(null,t)}};var fe=R;R.prototype._enumerate=function(){for(var t=this.length,e=this._input,n=0;this._state===oe&&t>n;n++)this._eachEntry(e[n],n)},R.prototype._eachEntry=function(t,e){var n=this._instanceConstructor,i=n.resolve;if(i===ne){var o=m(t);if(o===ee&&t._state!==oe)this._settledAt(t._state,e,t._result);else if("function"!=typeof o)this._remaining--,this._result[e]=t;else if(n===he){var r=new n(h);y(r,t,o),this._willSettleAt(r,e)}else this._willSettleAt(new n(function(e){e(t)}),e)}else this._willSettleAt(i(t),e)},R.prototype._settledAt=function(t,e,n){var i=this.promise;i._state===oe&&(this._remaining--,t===ae?P(i,n):this._result[e]=n),0===this._remaining&&_(i,this._result)},R.prototype._willSettleAt=function(t,e){var n=this;M(t,void 0,function(t){n._settledAt(re,e,t)},function(t){n._settledAt(ae,e,t)})};var ge=O,me={Promise:he,polyfill:ge};"function"==typeof define&&define.amd?define(function(){return me}):"undefined"!=typeof module&&module.exports?module.exports=me:"undefined"!=typeof this&&(this.ES6Promise=me),ge()}).call(this);var pdbComponentLibraryColors={colorBox:[[[51,123,177],[23,83,137],[5,54,106],[99,175,213],[176,229,251]],[[100,63,145],[100,46,131],[98,99,173],[101,28,117],[99,81,159]],[[154,69,21],[118,39,21],[83,10,21],[189,98,21],[224,127,21]],[[166,72,122],[115,39,89],[218,116,135],[227,146,149],[237,175,170]],[[50,120,114],[39,78,82],[59,156,132],[68,192,147],[74,232,156]],[[97,97,26],[73,73,25],[48,48,20],[118,118,23],[134,134,16]]],colorBox1:[[[0,55,55],[0,75,75],[0,94,94],[0,35,35],[0,114,114],[0,133,133],[0,153,153]],[[0,63,94],[0,76,114],[0,89,133],[0,102,153],[0,115,173],[0,128,192],[0,141,212]],[[51,73,51],[62,88,62],[72,103,72],[82,118,82],[93,133,93],[41,58,41],[103,148,103]]],colorBox2:[[[59,94,94],[53,100,100],[41,112,112],[35,118,118],[29,124,124],[24,129,129],[18,135,135],[12,141,141],[65,88,88]],[[59,82,94],[53,84,100],[47,86,106],[24,94,129],[12,98,141],[65,80,88],[0,102,153]],[[40,57,40],[48,68,48],[56,80,56],[64,91,64],[72,103,72],[80,115,80],[88,126,88],[32,45,32],[24,34,24],[96,138,96]]],colorBox3:[[[99,106,137],[110,118,151],[125,132,161],[140,146,172],[155,160,183]],[[114,72,103],[129,82,117],[145,92,131],[159,104,144],[98,62,89],[169,119,156]],[[111,78,55],[128,90,63],[145,102,72],[94,66,47],[77,54,38],[60,42,30]],[[75,83,32],[92,101,39],[108,120,46],[58,65,25],[42,46,18]],[[57,115,172],[64,128,191],[83,140,198],[121,166,210],[140,179,217]],[[0,81,59],[0,106,78],[0,132,97],[0,55,40],[0,157,116]],[[180,107,65],[191,120,80],[198,135,98],[205,149,117],[212,163,136]]],colorGradients:{redStack:[[128,0,0],[195,33,72],[135,38,87],[112,41,99],[255,56,0],[204,85,0],[255,0,0],[231,84,128],[207,113,175],[148,0,211],[255,127,80],[255,103,0],[244,194,194],[209,159,232],[255,140,0],[255,179,71]],greenStack:[[0,66,37],[85,107,47],[75,83,32],[19,136,8],[141,182,0],[23,114,69],[120,134,107],[3,192,60],[62,180,137]],darkStack:[[128,0,0],[0,0,128],[0,51,0],[102,0,102],[0,51,102],[51,51,0]]},specificColors:{lightGray:[105,105,105],burntOrange:[204,85,0],burgundy:[128,0,0],brass:[104,92,7],airForceBlue:[93,138,168],qualityGreen:[0,128,0],qualityYellow:[255,255,53],qualityRed:[204,0,0],burntOrangeBright:[204,85,0]}};!function(){angular.module("d3Core",[]).factory("d3",function(){return d3})}(),function(){"use strict";angular.module("pdb.common.services",[]).service("commonServices",["$http","$q",function(t){this.apiUrls={summary:"//www.ebi.ac.uk/pdbe/api/pdb/entry/summary/",entities:"//www.ebi.ac.uk/pdbe/api/pdb/entry/entities/",modifiedResidues:"//www.ebi.ac.uk/pdbe/api/pdb/entry/modified_AA_or_NA/",mutatedResidues:"//www.ebi.ac.uk/pdbe/api/pdb/entry/mutated_AA_or_NA/",polymerCoverage:"//www.ebi.ac.uk/pdbe/api/pdb/entry/polymer_coverage/",polymerCoveragePerChain:"//www.ebi.ac.uk/pdbe/api/pdb/entry/polymer_coverage/",bindingSites:"//www.ebi.ac.uk/pdbe/api/pdb/entry/binding_sites/",mappings:"//www.ebi.ac.uk/pdbe/api/mappings/",residueListing:"//www.ebi.ac.uk/pdbe/api/pdb/entry/residue_listing/",secStrutures:"//www.ebi.ac.uk/pdbe/api/pdb/entry/secondary_structure/",outliers:"//www.ebi.ac.uk/pdbe/api/validation/residuewise_outlier_summary/entry/",topology:"//www.ebi.ac.uk/pdbe/api/topology/entry/",molecules:"//www.ebi.ac.uk/pdbe/api/pdb/entry/molecules/",uniProtToPfam:"//www.ebi.ac.uk/pdbe/api/mappings/uniprot_to_pfam/",observedResidueRatio:"//www.ebi.ac.uk/pdbe/api/pdb/entry/observed_residues_ratio/",edm:"//www.ebi.ac.uk/pdbe/coordinates/files/",edm_diff:"//www.ebi.ac.uk/pdbe/coordinates/files/",uniprotSegments:"//www.ebi.ac.uk/pdbe/api/mappings/uniprot_segments/",residueListingPerChain:"//www.ebi.ac.uk/pdbe/api/pdb/entry/residue_listing/",bestStructures:"//www.ebi.ac.uk/pdbe/api/mappings/best_structures/",uniProtApiUrl:"//www.uniprot.org/uniprot/",pdbUniprotDetails:"//www.ebi.ac.uk/pdbe/entry/pdb/uniprot_details/"},this.createPromise=function(e,n,i){var o=this.apiUrls,r=n.map(function(n){if("uniProtApiUrl"===n)return t.get(o[n]+"?query=accession:"+e[0]+"&columns=id,sequence,entry name,protein names,organism,genes&format=tab&limit=1");if("pdbUniprotDetails"===n||"mappings"===n||"uniProtToPfam"===n||"bestStructures"===n)return t.get(o[n]+""+e[0]);if("polymerCoveragePerChain"===n||"topology"===n||"residueListingPerChain"===n)return t.get(o[n]+""+e[0]+"/chain/"+i);if("edm"===n)return t({url:o[n]+""+e[0]+".ccp4",method:"GET",responseType:"blob",cache:!0});if("edm_diff"===n)return t({url:o[n]+""+e[0]+"_diff.ccp4",method:"GET",responseType:"blob",cache:!0});if("uniprotSegments"===n){for(var r=e.length,a=[],s=0;r>s;s++)a.push(t.get(o[n]+""+e[s]));return a}return t({method:"POST",url:o[n],headers:{"Content-Type":"application/x-www-form-urlencoded"},data:e.join(",")})});return r},this.createMultiPromise=function(e,n){var i=this.apiUrls,o=e.map(function(e){return t.get(i[n[0]]+""+e)});return o},this.combinedDataGrabber=function(t,e,n,i){var o=t.map(function(t){return t.then(function(t){return{resolve:!0,result:t}},function(t){return{resolve:!1,result:t}})});return Promise.all(o).then(function(t){var e=[],o=[],r=!0;if(t.forEach(function(t){t.resolve&&(r=!1),e.push(t.resolve?t.result:null),o.push(t.resolve?null:t.result)}),r)throw o;if("undefined"!=typeof i&&i){var a={};return angular.forEach(e,function(t,e){null!==t&&"undefined"!=typeof t&&"undefined"!=typeof t.data&&t.data&&angular.forEach(t.data,function(t,i){var o="";"undefined"!=typeof t&&t&&(o=t),"undefined"==typeof a[i]&&(a[i]={});var r=void 0!=n[e]?n[e]:n[0];a[i][r]=o})}),a}return e})},this.sortMappingFragments=function(t){var e=1;return"-"===t[0]&&(e=-1,t=t.substr(1)),function(n,i){var o=n[t]<i[t]?-1:n[t]>i[t]?1:0;return o*e}},this.checkUniportGapProbability=function(t){for(var e=!1,n=t.length,i=0;n>i;i++){var o=t[i].unp_end-t[i].unp_start,r=t[i].end.residue_number-t[i].start.residue_number,a=o>0?o:-o,s=r>0?r:-r;if(a!=s){e=!0;break}}return e},this.colorBox=pdbComponentLibraryColors.colorBox,this.colorBox1=pdbComponentLibraryColors.colorBox1,this.colorBox2=pdbComponentLibraryColors.colorBox2,this.colorBox3=pdbComponentLibraryColors.colorBox3,this.colorGradients=pdbComponentLibraryColors.colorGradients,this.specificColors=pdbComponentLibraryColors.specificColors,this.availableEvents=[],this.createNewEvent=function(t){var e={};return angular.forEach(t,function(t){var n;"function"==typeof MouseEvent?n=new MouseEvent(t,{view:window,bubbles:!0,cancelable:!0}):"function"==typeof document.createEvent?(n=document.createEvent("MouseEvents"),n.initEvent(t,!0,!0)):"function"==typeof document.createEventObject&&(n=document.createEventObject()),e[t]=n}),e}}]),angular.module("pdb.uniprot.viewer.services",["pdb.common.services"]).service("uniprotViewerService",["$http","$q","$filter","commonServices",function(t,e,n,i){this.getUnipdbData=function(t){var n=e.defer(),o=["mappings","bestStructures","pdbUniprotDetails","uniProtToPfam"],r=i.createPromise([t],o);return i.combinedDataGrabber(r,[t],o,!1).then(function(e){(null==e[0]||null==e[2])&&(window.console&&console.log("Error : Uniprot API service request failed!"),n.reject("fail response"));var i=void 0;null!=e[1]&&(i=e[1].data[t]);var o=void 0;null!=e[3]&&(o=e[3]);var r=e[2].data,a={uniprotId:t,unipdbHeading:r.unipdbHeading,uniprotSeq:r.uniprotSeq,pdbMappings:e[0].data[t].PDB,bestStrMappings:i,pfamApiData:o};n.resolve(a)},function(){window.console&&console.log("Error : Uniprot API service request failed!"),n.reject("fail response")}),n.promise}}])}(),function(){"use strict";angular.module("pdb.uniprot.viewer.filters",["d3Core","pdb.uniprot.viewer.services","pdb.common.services"]).filter("uniProtMappingFilter",["commonServices","$filter",function(t,e){return function(n){var i={groups:[],shapes:[],infoIconMsg:{}},o={};if("undefined"==typeof n.uniprotSegmentMappings){var r=[];if("undefined"!=typeof n.bestStrMappings)for(var a=n.bestStrMappings.length,s=0;a>s;s++){var p=n.bestStrMappings[s].pdb_id;-1===r.indexOf(p)&&(r.push(p),o[p]=n.pdbMappings[p])}else o=n.pdbMappings;if(i={options:{seqId:n.uniprotId,seqStr:n.uniprotSeq,unipdbHeading:n.unipdbHeading,totalEntries:0,totalChains:0},groups:[{label:n.uniprotId,"class":"uniprotGrp",parentGroup:"",marginTop:8},{label:"","class":"uniprotPathGrp",parentGroup:"uniprotGrp",marginTop:1},{label:"","class":"pfamPathGrp",parentGroup:"uniprotGrp"},{label:"","class":"uniprotSeqGrp",parentGroup:"uniprotGrp",marginTop:14},{label:"","class":"pfamLabelGrp",parentGroup:"uniprotGrp",marginTop:14}],shapes:[{shape:"path",shapeGroupClass:"uniprotPathGrp",shapeClass:"seqPath uniprotPath",shapeHeight:20,marginTop:0,showTooltip:!0,shapeContent:[{pathRange:[[0,0],[n.uniprotSeq.length,0]],pathData:{uniprotId:n.uniprotId,uniprotSeq:n.uniprotSeq},color:t.specificColors.lightGray,elementType:"uniprot"}]},{shape:"sequence",shapeGroupClass:"uniprotSeqGrp",shapeClass:"uniprotSeq",showTooltip:!0,shapeContent:{pathRange:[[0,0],[n.uniprotSeq.length,0]],pathData:{uniprotId:n.uniprotId,uniprotSeq:n.uniprotSeq},color:t.specificColors.lightGray,elementType:"uniprot"}}],pdbIdArr:[],equalLengthpdbIdArr:[],unequalLengthpdbIdArr:[],fadedShapeData:{},infoIconMsg:{}},"undefined"!=typeof n.pfamApiData){var l=e("unpToPfamFilter")(n.pfamApiData,n.uniprotId);l.shapes[0].shapeContent.length>0&&(i.infoIconMsg.pfam=l.shapes[0].infoToolTipMsg,i.shapes.push(l.shapes[0]),i.shapes.push(l.shapes[1]))}}else o=n.uniprotSegmentMappings;var u=0,c=0;return angular.forEach(o,function(e,o){if("undefined"!=typeof n.uniprotSegmentMappings)u=n.fadedShapeData[o].initMargin,c=n.fadedShapeData[o].colorIndex;else{i.options.totalEntries++,i.options.totalChains++;var r=u+20;i.groups.push({label:o,"class":"pathGrp"+o,parentGroup:"",marginTop:r}),u+=30,i.groups.push({label:"","class":"seqGrp"+o,parentGroup:"",marginTop:u+3})}var a={shape:"sequence",shapeGroupClass:"seqGrp"+o,shapeClass:"seq"+o,showTooltip:!0},s={shape:"path",shapeGroupClass:"pathGrp"+o,shapeClass:"seqPath path"+o+" path"+o,shapeHeight:20,showTooltip:!0,shapeContent:[]},p={shape:"text",shapeGroupClass:"seqGrp"+o,shapeClass:"hideTextOnZoom chain_id_text",shapeHeight:15,marginTop:2,showTooltip:!0,shapeContent:[]},l=[],d="This shows how sequences in PDB entry "+o+" cover the sequence of UniProt entry "+n.uniprotId+".",h="undefined"!=typeof n.uniprotSegmentMappings?!1:t.checkUniportGapProbability(e);if(h){var f={mappingApiData:e,colorIndex:c,initMargin:u};a.shapeClass="loadingseq seq"+o,s.shapeClass="loadingpath loadingpath"+o,s.shapeContent.push({pathRange:[[0,0],[n.uniprotSeq.length,0]],pathData:f,color:t.colorBox3[c][0],tooltipMsg:"Loading UniProt mappings for "+o,opacity:.3}),p.shapeClass="loading_path_text",p.shapeContent.push({textRange:[[2,0],[-9,0]],textString:"Loading UniProt mappings for "+o,pathData:f,textAnchor:"left"}),i.unequalLengthpdbIdArr.push(o),i.fadedShapeData[o]=f}else{var g=e.sort(t.sortMappingFragments("unp_start")),m=0,v=t.colorBox3[c].length;angular.forEach(g,function(e){var o="<br>UniProt range "+e.unp_start+"-"+e.unp_end+"<br>PDB range: "+e.start.residue_number+" - "+e.end.residue_number,r=e.unp_start+"-"+e.unp_end,a=l.indexOf(r);-1===a?(e.pathColor=t.colorBox3[c][m],s.shapeContent.push({pathRange:[[e.unp_start-1,0],[e.unp_end-1,0]],pathData:e,color:t.colorBox3[c][m],tooltipMsg:o,tooltipPosition:"postfix",type:"PDB"}),p.shapeContent.push({pathRange:[[e.unp_start-1,0],[e.unp_end-1,0]],textRange:[[e.unp_start+2,0],[-9,0]],textString:e.struct_asym_id,pathData:e,color:t.colorBox3[c][m],textAnchor:"left",tooltipMsg:o,tooltipPosition:"postfix",type:"PDB"}),l.push(e.unp_start+"-"+e.unp_end),m++,m===v&&(m=0)):("undefined"==typeof n.uniprotSegmentMappings&&i.options.totalChains++,s.shapeContent[a].pathData.chainId+=","+e.struct_asym_id,p.shapeContent[a].textString+=", "+e.struct_asym_id),d+="<br>- UniProt range "+e.unp_start+"-"+e.unp_end+" ("+(e.unp_end-e.unp_start+1)+" residues)corresponds to residues "+e.struct_asym_id+":"+e.start.residue_number+": - "+e.struct_asym_id+":"+e.end.residue_number+": in PDB entry."}),"undefined"==typeof n.uniprotSegmentMappings&&i.equalLengthpdbIdArr.push(o)}i.shapes.push(a,s,p),i.groups.push({label:o,"class":"straightLineGrp"+o,parentGroup:"",marginTop:r}),i.infoIconMsg[o]=d,"undefined"==typeof n.uniprotSegmentMappings&&(i.pdbIdArr.push(o),c++,c===t.colorBox3.length&&(c=0))}),i}}]).filter("modifiedResFilter",["commonServices",function(t){return function(e,n,i,o,r,a,s,p){var l=[],u=function(t,e){var n={residueNum:e.residue_number,chainId:e.chain_id,entityId:e.entity_id,structAsymId:e.struct_asym_id},i=-1;return angular.forEach(t,function(t){var e={pdbStart:t.pathData.start.residue_number,pdbEnd:t.pathData.end.residue_number,unpStart:t.pathRange[0][0]+1,unpEnd:t.pathRange[1][0]+1,chainId:t.pathData.chain_id,entityId:t.pathData.entity_id,structAsymId:t.pathData.struct_asym_id};n.residueNum>=e.pdbStart&&n.residueNum<=e.pdbEnd&&n.structAsymId<=e.structAsymId&&n.entityId<=e.entityId&&(i=n.residueNum-(e.pdbStart-e.unpStart))}),i},c={shape:"path",shapeGroupClass:"mutationGrp_"+i,shapeClass:"mutation_"+i,shapeHeight:o,marginTop:r,showTooltip:!0,shapeContent:[]},d={shape:"text",shapeGroupClass:"mutationGrp_"+i,shapeClass:"showTextOnZoom singleTextEle mutation_text_"+i,shapeHeight:o,marginTop:r,showTooltip:!0,shapeContent:[]};return angular.forEach(e,function(e){var i=e.residue_number;if("unipdbe"===p)i=u(n,e);else if(e.entity_id!=n.entityId)return;var o="",r="";"undefined"!=typeof e.mutation_details&&"mutatedResidues"===s?(null!==e.mutation_details.from&&(o+=e.mutation_details.from+" --> "),o+=e.mutation_details.to+" ("+e.mutation_details.type+")",r=e.mutation_details.to):(o="Modified Residue: "+e.chem_comp_id,r=""),i>-1&&(c.shapeContent.push({pathRange:[[i-1-.5,0],[i-1+.5,0]],tooltipMsg:o,pathData:e,color:t.specificColors.burntOrange}),d.shapeContent.push({textRange:[[i-1,0],[a,0]],tooltipMsg:o,textString:r,pathData:e,color:t.specificColors.burntOrange}))}),c.shapeContent.length>0&&l.push(c),d.shapeContent.length>0&&l.push(d),l}}]).filter("unipdbModelFilter",["d3","$filter",function(t,e){return function(n,i,o){var r={groups:[],shapes:[]};return angular.forEach(n,function(n,i){var a=o.select(".pathGrp"+i).attr("transform"),s=/\((.+),(.+)\)/,p=a.match(s),l=[p[1],p[2]],u=t.selectAll(".path"+i).data();angular.forEach(n,function(t,n){if("undefined"!=typeof t&&t)if("modifiedResidues"===n||"mutatedResidues"===n){var o=e("modifiedResFilter")(t,u,i,20,10,14,n,"unipdbe");o.length>0&&(r.groups.push({label:"","class":"mutationGrp mutationGrp_"+i,parentGroup:"",marginTop:l[1]-25}),r.shapes=r.shapes.concat(o))}else if("molecules"===n){for(var a={},s={},p=0,c=0,d=t.length,h=0;d>h&&(a={shape:"zigzag",shapeGroupClass:"pathGrp"+i,shapeClass:"linkerPath"+i+" linkerPath"+i,shapeHeight:20,showTooltip:!0,shapeContent:[]},s={shape:"path",shapeGroupClass:"straightLineGrp"+i,shapeClass:"linePathEle straightLinePath"+i+" straightLinePath"+i,shapeHeight:3,showTooltip:!0,shapeContent:[]},angular.forEach(u,function(e,n){if(e.pathData.entity_id===t[h].entity_id){var i=t[h].length,o=e.pathData.start.residue_number,r=e.pathData.end.residue_number;if(a.shapeColour=e.pathData.pathColor,0===c&&o>1||c>0&&o>c){var l="Beginning 1 - "+(o-1)+" residues are not mapped to UniProt";o-1==1&&(l="Residue "+(o-1)+" is not mapped to UniProt"),a.shapeContent.push({pathStart:e.pathData.unp_start-1,pathPosition:"start",tooltipMsg:l,pathData:e.pathData,color:e.pathData.pathColor})}if(i>r){var d="Ending "+(parseInt(r)+1)+" - "+i+" residues are not mapped to UniProt";parseInt(r)+1==i&&(d="Residue "+(parseInt(r)+1)+" is not mapped to UniProt"),a.shapeContent.push({pathStart:e.pathData.unp_end-1,pathPosition:"end",tooltipMsg:d,pathData:e.pathData,color:e.pathData.pathColor})}if(p++,"undefined"!=typeof u[n+1]&&r<=u[n+1].pathData.start.residue_number&&u[n+1].pathData.unp_start>e.pathData.unp_end)if(u[n+1].pathData.start.residue_number===r+1)s.shapeContent.push({pathRange:[[e.pathData.unp_end-1,0],[u[n+1].pathData.unp_start-1,0]],tooltipMsg:"Uniprot Residues "+(parseInt(e.pathData.unp_end)+1)+"-"+(u[n+1].pathData.unp_start-1)+" are deleted",pathData:e.pathData,color:[0,0,0]});else{var f=(u[n+1].pathData.unp_start-e.pathData.unp_end)/4;s.shapeContent.push({pathRange:[[e.pathData.unp_end-1,0],[e.pathData.unp_end-1+f,-5],[e.pathData.unp_end-1+2*f,0],[e.pathData.unp_end-1+3*f,5],[u[n+1].pathData.unp_start-1,0]],tooltipMsg:parseInt(r)+1+"-"+(u[n+1].pathData.start.residue_number-1)+" residues are not mapped to UniProt",pathData:e.pathData,color:[0,0,0]})}}}),p!=u.length);h++);s.shapeContent.length>0&&r.shapes.push(s),a.shapeContent.length>0&&r.shapes.push(a)}})}),r}}]).filter("unpToPfamFilter",["commonServices",function(t){return function(e,n){var i={},o={};if(!angular.isUndefined(e)&&e&&!angular.isUndefined(e.data)&&e.data){o={shape:"text",shapeGroupClass:"pfamLabelGrp",shapeClass:"hideTextOnZoom pfam_text",shapeColour:void 0,shapeHeight:15,marginTop:2,showTooltip:!0,shapeContent:[],fitInPath:!0},i={shape:"path",shapeGroupClass:"pfamPathGrp",shapeClass:"pfamPath",shapeHeight:30,showTooltip:!0,shapeContent:[],infoToolTipMsg:"This UniProt entry contains the following Pfam domain:"};var r=0;angular.forEach(e.data[n].Pfam,function(e,n){var a=e.mappings.length,s=" of "+e.name+" ("+n+": "+e.description+") mapping to residues ";angular.forEach(e.mappings,function(p,l){l>0&&(s+=l===a-1?" and":","),s+=" "+p.unp_start+"-"+p.unp_end,i.shapeContent.push({pathRange:[[p.unp_start-1,0],[p.unp_end-1,0]],pathData:{pfamId:n,pfamData:e},color:t.colorGradients.redStack[r],tooltipMsg:"<br><strong>"+n+"</strong><br>UniProt range: "+p.unp_start+"-"+p.unp_end+"<br>"+e.description,tooltipPosition:"postfix"}),o.shapeContent.push({textRange:[[p.unp_start+(p.unp_end-p.unp_start)/2-1,0],[-10,0]],textString:e.name,pathData:e,pathClassPrefix:"pfamPath",fitInPath:!0,tooltipMsg:"<br><strong>"+n+"</strong><br>UniProt range: "+p.unp_start+"-"+p.unp_end+"<br>"+e.description,tooltipPosition:"postfix",elementType:"Pfam"}),l===a-1&&(s=0===l?"<br> - one copy"+s:"<br> - "+a+" copies"+s),r++,r===t.colorGradients.redStack.length&&(r=0)}),i.infoToolTipMsg+=s,s=""})}return{shapes:[i,o]}}}])}(),angular.module("template/sequenceView/uniPdb.html",[]).run(["$templateCache",function(t){t.put("template/sequenceView/uniPdb.html",'<div class="seqViewerWrapper" ng-style="styles.wrapper"><div ng-style="seqViewerOverlay" ng-show="overlayText != \'\'"><span ng-style="seqViewerOverlayMessage">{{overlayText}}</span></div><div class="unipdbHeader"><div class="headingTxt" ng-show="wrapperSize.width > 300"></div><div class="button-group" ng-show="showViewBtn"><ul><li><a ng-click="activeViewBtn = \'compact\'" ng-class="{\'active\' : activeViewBtn == \'compact\'}" title="Compact View" href="javascript:void(0);">Compact</a></li><li><a ng-click="activeViewBtn = \'expanded\'" ng-class="{\'active\' : activeViewBtn == \'expanded\'}" title="Expanded View" href="javascript:void(0);">Expanded</a></li></ul></div></div><div class="topSection" ng-style="styles.topSection"><div class="topLeftSection" ng-style="styles.leftSecStyle"><div class="unipdbMappingDesc">{{modelOptions.totalChains}} chains in {{modelOptions.totalEntries}} PDB entries map to this Uniprot accession.</div><div class="topLeftIconSection"><div class="uniprotHeadId" ng-style="styles.accWidth"><a title="Click to go to the UniProt page for this sequence" target="_blank" href="//www.uniprot.org/uniprot/{{modelOptions.seqId}}">{{modelOptions.seqId}}</a></div><div class="infoIconWarpper" ng-show="wrapperSize.width > 300"><img ng-src="//www.ebi.ac.uk/pdbe/widgets/html/PinupIcons/Button-Details-icon.png" border="0" ng-mousemove="showTooltip(infoIconMsg[\'pfam\'], \'ng\', $event)" ng-mouseleave="hideTooltip()" /><a href="//www.uniprot.org/uniprot/{{modelOptions.seqId}}.txt" title="See the entry text file" target="_blank" style="margin-left:5px;"><img ng-src="//www.ebi.ac.uk/pdbe/widgets/html/PinupIcons/Button-Download-icon.png" /></a></div></div></div><a class="SeqScrollArrow" ng-style="styles.scrollArrowLeft" href="javascript:void(0);" title="Scroll Left"><span ng-mouseup="stopMovingPan()" ng-mousemove="stopMovingPan()" ng-mousedown="movePan(50)" class="icon-black" data-icon="&lt;"></span></a><div class="topRightSection"><svg class="topSvg" ng-style="styles.topSvg"><g class="scaleGrp" transform="translate(10,25)"><g class="x axis"></g></g></svn></div><a class="SeqScrollArrow" ng-style="styles.scrollArrowRight" href="javascript:void(0);" title="Scroll Right"><span ng-mouseup="stopMovingPan()" ng-mousemove="stopMovingPan()" ng-mousedown="movePan(-50)" class="icon-black" data-icon="&gt;"></span></a></div><div class="bottomSection" ng-style="styles.bottomSection"><div class="bottomLeftSection" ng-style="styles.leftSecStyle"><div ng-repeat="msgPdbId in pdbIdArr" ng-style="{\'width\':\'100%\', \'text-align\':\'right\', \'margin-top\': $index == 0 ? printsMarginTop+\'px\' : \'6px\', \'height\': \'24px\', \'line-height\': \'24px\'}"><div class="leftPdbIdLabel"><a href="//www.ebi.ac.uk/pdbe/entry/pdb/{{msgPdbId}}/" target="_blank"  title="For more information about key features of entry {{msgPdbId}}, click on the individual icons.">{{msgPdbId}}</a></div><div class="pdbprints_{{msgPdbId}}"></div><div class="infoIconWarpper"> <img ng-src="//www.ebi.ac.uk/pdbe/widgets/html/PinupIcons/Button-Details-icon.png" border="0" ng-mousemove="showTooltip(infoIconMsg[msgPdbId], \'ng\', $event)" ng-mouseleave="hideTooltip()" ng-show="wrapperSize.width > 300" /><a href="//www.ebi.ac.uk/pdbe-srv/view/files/{{msgPdbId}}.ent" title="See the entry text file" target="_blank" style="margin-left:5px;"><img ng-src="//www.ebi.ac.uk/pdbe/widgets/html/PinupIcons/Button-Download-icon.png" border="0" /></a></div></div></div><div class="bottomRightSection"><svg class="bottomSvg" ng-style="styles.bottomSvg" ><g class="shapesGrp" transform="translate(10,-21)"><rect class="seqSvgBg" x="0" y="0" fill="none" stroke="none" ng-style="styles.bottomSvg" ></rect></g></svg></div></div></div>')}]),function(){"use strict";angular.module("pdb.uniprot.viewer",["pdb.prints","d3Core","pdb.uniprot.viewer.filters","pdb.uniprot.viewer.services","pdb.common.services","template/sequenceView/uniPdb.html"]).directive("pdbUniprotViewer",["d3","uniprotViewerService","$compile","$filter","$interval","commonServices","$document","$window","$q",function(t,e,n,i,o,r,a,s,p){return{restrict:"EAC",scope:{entryId:"@",height:"@",width:"@",hidePdbPrints:"@"},templateUrl:"template/sequenceView/uniPdb.html",link:function(a,s){a.seqViewerOverlay={width:"90%",height:"100%","background-color":"rgba(0,0,0,0.5)",color:"#fff","z-index":1,position:"absolute","text-align":"center",padding:"0 5%","webkit-box-sizing":"content-box","-moz-box-sizing":"content-box","box-sizing":"content-box"},a.seqViewerOverlayMessage={display:"inline-block","margin-top":"5%","font-size":"12px"},a.overlayText="Loading...";var l=t.select(s[0]),u=l.select(".seqViewerWrapper"),c=u.select(".topRightSection"),d=u.select(".bottomRightSection"),h=d.select(".bottomSvg"),f=h.select("g.shapesGrp"),g=c.select("g.scaleGrp"),m=l.node().parentNode.getBoundingClientRect();a.config={width:m.width>230?m.width:230,height:m.height>250?m.height:250,showLabels:!0,maxZoomed:!1,pdbPrints:!0,firstPrintsMarginTop:3},"undefined"!=typeof a.hidePdbPrints&&"true"==a.hidePdbPrints&&(a.config.pdbPrints=!1),"undefined"!=typeof a.height&&(a.config.height=a.height),"undefined"!=typeof a.width&&(a.config.width=a.width),a.activeViewBtn="compact",a.showViewBtn=!0,a.allowZoom=!0,a.showLabels=a.config.showLabels,a.printsMarginTop=a.config.firstPrintsMarginTop;var v=new function(){this.margin={top:15,right:10,bottom:15,left:10},this.topSvgHeight=70,this.topButtonHeight=45,this.headerSecHeight=60,this.mainHeight=a.config.height,this.leftSecWidthCalc=function(){var t=a.config.width>300?210:110;return t=a.config.pdbPrints?t:110},this.leftSecWidth=this.leftSecWidthCalc(),this.scrollbarWidth=25,this.scrollRightMargin=5,this.mainWidth=a.config.width,this.sectionWidth=this.mainWidth-this.scrollRightMargin,this.bottomSecHeigth=this.mainHeight-this.topSvgHeight-this.headerSecHeight-this.margin.bottom,this.svgWidth=this.sectionWidth-this.leftSecWidth-this.scrollbarWidth,this.svgScaleWidth=this.svgWidth-20,this.tickCount=this.svgWidth/28,this.seqViewerSmallOverlay="position: absolute;padding: 5px;color: #fff;background-color: rgba(0, 0, 0, 0.498039);width: 27%;font-size: 10px;margin-left: 40%;top:0;text-align:center;",this.accWidth=this.leftSecWidth>110?150:57};if(a.styles={wrapper:{width:v.mainWidth+"px",height:v.mainHeight+"px"},loaderImg:{"margin-top":v.mainHeight/2-30+"px"},topSection:{height:v.topSvgHeight+"px",width:v.sectionWidth+"px"},topSvg:{height:v.topSvgHeight+"px",width:v.svgWidth+"px",overflow:"visible"},bottomSection:{height:v.bottomSecHeigth+"px",width:v.sectionWidth+"px","overflow-x":"hidden","overflow-y":"auto"},bottomSvg:{width:v.svgWidth+"px",overflow:"visible"},leftSecStyle:{width:v.leftSecWidth+"px"},scrollArrowLeft:{display:"none",position:"absolute",margin:"8px 0 0 "+(v.leftSecWidth-10)+"px","text-decoration":"none",border:"none",outline:"none"},scrollArrowRight:{display:"none",margin:"8px 0 0 20px","text-decoration":"none",border:"none",outline:"none"},loadMoreStyle:{top:v.mainHeight-35+"px",left:v.mainWidth/2-50+"px"},btnGrp:{"float":"left","margin-bottom":"5px",width:v.mainWidth+"px","text-align":"right",overflow:"auto"},accWidth:{width:v.accWidth+"px"}},a.wrapperSize={width:v.mainWidth,height:v.mainHeight},"undefined"==typeof a.entryId)return a.overlayText="Please specify 'entry-id'",void 0;var b=t.select(".pdbSeqTooltip");null==b[0][0]&&(b=t.select("body").append("div").attr("class","pdbSeqTooltip")),a.pdbevents=r.createNewEvent(["PDB.uniprotViewer.click","PDB.uniprotViewer.mouseover","PDB.uniprotViewer.mouseout"]);var w=function(){function o(){this.smallSeqFlag=!1,this.shapeMaster={},this.renderViewModel=void 0,this.seqLength=0,this.scaleConfig=void 0,this.xScale=void 0,this.line=void 0,this.zoom=void 0,this.xAxis=void 0,this.seqAxis=void 0,this.tickCount=v.tickCount,this.clipPathId=void 0,this.initUniPdbViewer()
}return o.prototype.initUniPdbViewer=function(){var t=this;a.overlayText="Downloading UniPDB API Data...",e.getUnipdbData(a.entryId).then(function(e){a.overlayText="Parsing UniPDB API Data...",t.renderViewModel=i("uniProtMappingFilter")(e),t.initScaleAndZoom(),u.select(".headingTxt").html(t.renderViewModel.options.unipdbHeading),t.initPDBPrints(),a.overlayText="Rendering View...",t.renderShapes(t.renderViewModel),t.smallSeqFlag&&(a.showViewBtn=!1),t.setMainSvgHeight(),a.config.maxZoomed&&(t.zoom.scale(t.scaleConfig.maxZoom),t.zoomDraw()),a.overlayText="",t.renderViewModel.equalLengthpdbIdArr.length>0&&t.renderMutationAnnotationsForUniPDB(t.renderViewModel.equalLengthpdbIdArr),t.renderViewModel.unequalLengthpdbIdArr.length>0&&t.loadUnequalLengthMappings().then(function(){t.renderMutationAnnotationsForUniPDB(t.renderViewModel.unequalLengthpdbIdArr)}),a.config.maxZoomed&&(t.zoom.scale(maxZoom),t.zoomDraw()),t.smallSeqFlag&&(a.showViewBtn=!1)},function(t){a.overlayText="Unipdb API request failed...",window.console&&console.log("Unipdb API request failed. Error: "+t)})},o.prototype.renderMutationAnnotationsForUniPDB=function(t){var e=this;u.append("div").classed("smallOverlayMutation",!0).text("Loading Mutation/Modified Annotation..").attr("style",v.seqViewerSmallOverlay);var n=["mutatedResidues","modifiedResidues","molecules"],o=r.createPromise(t,n);r.combinedDataGrabber(o,t,n,!0).then(function(t){var n=i("unipdbModelFilter")(t,v.margin.top,l);e.renderShapes(n),u.select(".smallOverlayMutation").remove()},function(){u.select(".smallOverlayMutation").remove(),window.console&&console.log("combined Failed")})},o.prototype.loadUnequalLengthMappings=function(){var t=this;a.fadedShapeData=t.renderViewModel.fadedShapeData;var e=p.defer();u.append("div").classed("smallOverlayMutation",!0).text("Loading remaining mappings data..").attr("style",v.seqViewerSmallOverlay);var n=["uniprotSegments"],o=r.createMultiPromise(t.renderViewModel.unequalLengthpdbIdArr,n);return r.combinedDataGrabber(o,t.renderViewModel.unequalLengthpdbIdArr,n,!0).then(function(n){var o={};angular.forEach(n,function(t,e){o[e]=t.uniprotSegments.UniProt[a.entryId].mappings});var r={uniprotId:a.entryId,uniprotSegmentMappings:o,fadedShapeData:a.fadedShapeData},s=i("uniProtMappingFilter")(r);s.groups=[],u.selectAll(".loadingseq").remove(),u.selectAll(".loadingpath").remove(),u.selectAll(".loading_path_text").remove(),t.renderShapes(s),angular.forEach(s.infoIconMsg,function(t,e){a.infoIconMsg[e]=t}),u.selectAll(".smallOverlayMutation").remove(),e.resolve(s)},function(){u.select(".smallOverlayMutation").remove(),window.console&&console.log("combined Failed"),e.reject("fail response")}),e.promise},o.prototype.initPDBPrints=function(){var t=this;if(a.config.width>300&&a.config.pdbPrints){var e="['"+t.renderViewModel.pdbIdArr.join("','")+"']",i=u.select(".bottomLeftSection").classed("pdb-prints",!0).attr("pdb-ids",e).attr("settings",'{"orientation": "horizontal", "size": 24, "color": "embl_green", "hideLogo" : ["PDBeLogo","Taxonomy", "Expressed", "Protein"] }');n(i.node())(a)}},o.prototype.initScaleAndZoom=function(){var e=this;a.overlayText="Initalizing scale and zoom...",a.infoIconMsg=e.renderViewModel.infoIconMsg,a.pathLeftLabels=e.renderViewModel.pathLeftLabels,a.pathMoreLeftLabels=[],a.pdbIdArr=e.renderViewModel.pdbIdArr,a.entrySummary=e.renderViewModel.options,a.modelOptions=a.entrySummary,e.sequenceArr=a.entrySummary.seqStr.split(""),e.seqLength=e.sequenceArr.length,e.scaleConfig={indexMax:e.seqLength-1,minZoom:1,maxZoom:e.getMaxZoom(e.seqLength,v.svgScaleWidth)},e.seqLength<=Math.ceil(v.tickCount)&&(e.tickCount=e.seqLength,e.smallSeqFlag=!0),e.xScale=t.scale.linear().domain([0,e.scaleConfig.indexMax]).range([0,v.svgScaleWidth]),e.line=t.svg.line().x(function(t){return e.xScale(t[0])}),e.xAxis=t.svg.axis().scale(e.xScale).orient("top").tickFormat(function(t){return t+1}).ticks(e.tickCount),e.seqAxis=t.svg.axis().scale(e.xScale).orient("top").tickFormat(function(t){return e.sequenceArr[t]}).ticks(e.tickCount);var n=g.select("g.x.axis").call(e.xAxis);e.seqLength===n.selectAll("g.tick")[0].length&&(e.smallSeqFlag=!0),e.zoom=t.behavior.zoom().on("zoom",function(){e.zoomDraw(e)}).x(e.xScale).scaleExtent([e.scaleConfig.minZoom,e.scaleConfig.maxZoom]),c.select(".topSvg").call(e.zoom),d.select(".shapesGrp").call(e.zoom),e.clipPathId="clipper_"+Math.floor(500*Math.random()+1),h.append("defs").append("clipPath").attr("id",e.clipPathId).append("rect").attr("x",-10).attr("y",-30).attr("width",v.svgWidth).attr("height",100)},o.prototype.renderShapes=function(t){var e=this;for(var n in t)if("groups"===n)for(var i=t[n].length,o=0;i>o;o++){var r=t[n][o]["class"],a=t[n][o].parentGroup,s=t[n][o].marginTop,p=(t[n][o].label,f);("uniprotGrp"===a||"uniprotGrp"===r)&&(p=g),""!==a?(p.select("."+a).append("g").attr("class",r),"undefined"!=typeof s&&s&&p.select("."+r).attr("transform","translate(0,"+s+")")):p.append("g").attr("class",r).attr("transform","translate(0,"+(v.margin.top+s)+")").attr("clip-path","url(#"+e.clipPathId+")")}else if("shapes"===n)for(var l=t[n].length,u=0;l>u;u++){var c=t[n][u].shape,d=t[n][u].shapeGroupClass,h=t[n][u].shapeClass,m=t[n][u].shapeContent,b=t[n][u].shapeColour,w=t[n][u].shapeHeight,y=t[n][u].marginTop,x=t[n][u].shapeCap,S=t[n][u].showTooltip,_=t[n][u].fitInPath;"undefined"==typeof w&&(w=0),"undefined"==typeof y&&(y=0),"undefined"==typeof x&&(x="butt"),"text"===c?(e.drawText(m,d,h,S,_),e.displaySeq()):"zigzag"===c?e.drawZigzag(m,d,h,b,w,y,x,S):"arrow"===c?e.drawArrow(m,d,h,b,w,y,x,S):"path"===c?e.drawPath(m,d,h,b,w,y,x,S):"circle"===c||"square"===c||"triangle-up"===c||"triangle-down"===c||"diamond"===c||"cross"===c?e.createShape(c,m,d,h,b,S,y):"sequence"===c&&(e.drawSeqAxis(m,d,h,y,S),e.displaySeq())}},o.prototype.setMainSvgHeight=function(){var t=40;h.select(".seqSvgBg").attr("height",20);var e=f.node().getBBox();h.attr("height",e.height+t),h.select(".seqSvgBg").attr("height",e.height+t)},o.prototype.drawText=function(e,n,i,o,r){var a=this,s=l.select("."+n).attr("clip-path","url(#"+a.clipPathId+")").selectAll("path."+i).data(e).enter().append("text").attr("class",function(t,e){return t.textIndex=e,"textEle "+i+" "+i+"-"+e}).attr("x",function(t){return a.xScale(t.textRange[0][0])}).attr("y",function(t){return t.textRange[1][0]}).attr("fill","white").text(function(t){return t.textString}).style("text-anchor",function(e){return o===!0&&a.attachMouseEvent(t.select(this),"text","white",e),"undefined"!=typeof e.textAnchor?e.textAnchor:"middle"}).style("font-family","Verdana,sans-serif").style("font-size","12px").style("cursor","default");r===!0&&(a.fitTextInPath(s),s.classed("fitTextInPath",!0),s.style("display","none"))},o.prototype.fitTextInPath=function(e){var n=this;e.each(function(){var e=t.select(this),i=e.data()[0],o=l.select("."+i.pathClassPrefix+"-"+i.textIndex).node().getBBox().width;n.textFontResize(e,o)})},o.prototype.textFontResize=function(t,e){var n=this,i=t.node().getBBox().width;if(i>e){var o=parseInt(t.style("font-size"));o>2?(t.style("font-size",o-2+"px"),n.textFontResize(t,e)):t.style("font-size","0px")}},o.prototype.drawZigzag=function(e,n,i,o,r,a,s,p){var u=this;l.select("."+n).attr("clip-path","url(#"+u.clipPathId+")").selectAll("path."+i).data(e).enter().append("path").attr("class",function(t,e){return"linkerPathEle "+i+"-"+e}).attr("stroke",function(e){return t.rgb(e.color[0],e.color[1],e.color[2]).brighter()}).attr("stroke-width",2).attr("stroke-linecap",s).attr("fill",function(e){return t.rgb(e.color[0],e.color[1],e.color[2]).brighter()}).attr("transform","translate(0,-9)").attr("d",function(e){if(1==p){var n=t.rgb(e.color[0],e.color[1],e.color[2]).brighter();u.attachMouseEvent(t.select(this),"path",n,e)}var i=u.getZigZagdVal(u.xScale(e.pathStart),e.pathPosition);return i})},o.prototype.getZigZagdVal=function(t,e){var n=["M","0L","0L","3L","6L","9L","12L","15L","18L"],i=0,o="",r=5;return"start"===e&&(r=-5),angular.forEach(n,function(e){var n=0;0===i?(i=1,n=t):(i=0,n=t+r),o+=e+""+n+","}),o+="18 Z"},o.prototype.createShape=function(e,n,i,o,r,a,s){var p=this;p.shapeMaster[o]=e,l.select("."+i).attr("clip-path","url(#"+p.clipPathId+")").selectAll("otherPathShape path."+o).data(n).enter().append("path").attr("class",o).attr("d",p.getShapeDVal(e)).attr("fill",function(e){var n;return n="undefined"!=typeof e.color?t.rgb(e.color[0],e.color[1],e.color[2]).brighter():r,1==a&&p.attachMouseEvent(t.select(this),"circle",n,e),n}).attr("stroke","none").attr("stroke-width",0).attr("transform",function(t){var e="translate("+p.xScale(t.residue_number-1)+",10)";return 0!==s&&(e="translate("+p.xScale(t.residue_number-1)+","+s+")"),e})},o.prototype.getShapeDVal=function(e){var n=this;return t.svg.symbol().type(e).size(function(){return n.smallSeqFlag?40:10*n.getShapeSize(n.zoom.scale())})},o.prototype.getShapeSize=function(t){return 1.7>t?t=1.7:t>4.5&&(t=4.5),t},o.prototype.drawSeqAxis=function(t,e,n,i,o){var r=this;l.select("."+e).append("g").attr("class","seqAxis "+n);var a=l.select("."+n);a.call(r.seqAxis),i&&"undefined"!=typeof i&&a.attr("transform","translate(0,"+i+")"),1==o&&r.attachMouseEvent(a,"text","white",t)},o.prototype.drawPath=function(e,n,i,o,r,a,s,p){var u=this;l.select("."+n).attr("clip-path","url(#"+u.clipPathId+")").selectAll("path."+i).data(e).enter().append("path").attr("class",function(t,e){return"pathEle "+i+"-"+e}).attr("stroke",function(e){var n;if("undefined"!=typeof e.color){var i=t.rgb(e.color[0],e.color[1],e.color[2]).brighter();n=i}else n=o;return 1==p&&u.attachMouseEvent(t.select(this),"path",n,e),n}).attr("stroke-width",r).attr("stroke-opacity",function(t){return"undefined"!=typeof t.opacity?t.opacity:1}).attr("stroke-linecap",s).attr("fill","none").attr("transform","translate(0,"+a+")").attr("d",function(t){return u.line(t.pathRange)})},o.prototype.drawArrow=function(e,n,i,o,r,a,s,p){var u=this;l.select("."+n).attr("clip-path","url(#"+u.clipPathId+")").selectAll("path."+i).data(e).enter().append("path").attr("class",function(t,e){return"arrowEle "+i+"-"+e}).attr("stroke",function(e){var n=t.rgb(e.color[0],e.color[1],e.color[2]).brighter();return 1==p&&u.attachMouseEvent(t.select(this),"arrow",n,e),n}).attr("stroke-width",r).attr("stroke-linecap",s).attr("fill",function(e){return t.rgb(e.color[0],e.color[1],e.color[2]).brighter()}).attr("transform","translate(0,"+a+")").attr("d",function(t){return u.getArrowDVal(u.line(t.pathRange))})},o.prototype.getArrowDVal=function(t){var e=t.split(","),n=parseFloat(e[0].substring(1)),i=parseFloat(e[1].substring(2)),o=i-n+1,r=5;10>o&&(r=o-2);var a="M"+n+",-5L"+(i-r)+",-5L"+(i-r)+",-10L"+i+",0L"+(i-r)+",10L"+(i-r)+",5L"+n+",5";return a},o.prototype.getMaxZoom=function(t,e){var n=this,i=0;if(e%100===0)i=.2112*t/n.getZoomDivisor(e);else{var o=100*Math.floor(e/100);1>o&&(o=100);var r=.2112*t/n.getZoomDivisor(o),a={100:{diff:2,range:[1,2,4,7,9]},200:{diff:1.5,range:[2,5]},300:{diff:.9,range:[4,9]},400:{diff:.7,range:[5,9]},500:{diff:.6,range:[1,9]},600:{diff:.45,range:[8,9]},700:{diff:.4,range:[8,9]}};if(800>e){for(var s=a[o].range.length,p=s-1;p>=0;p--)if(e>=o+10*a[o].range[p]){i=0===p?r:r-a[o].diff/100*t*p;break}}else i=.2112*t/n.getZoomDivisor(o)}return 0===i&&(i=r),i},o.prototype.getZoomDivisor=function(t){var e=1;return t>100&&(e=Math.floor(Math.floor(t)/100)),e},o.prototype.displaySeq=function(){var e=this;if(e.smallSeqFlag||e.zoom.scale()===e.scaleConfig.maxZoom){l.selectAll(".linkerPathEle").attr("d",function(t){var n=0;n="start"===t.pathPosition?t.pathStart-.1:t.pathStart+.1;var i=e.getZigZagdVal(e.xScale(n),t.pathPosition);return i}),l.selectAll(".seqPath").attr("d",function(t){var n=e.line(t.pathRange),i=n.split(",");return i[0]="M"+(parseFloat(i[0].substring(1))-5),i[1]="0L"+(parseFloat(i[1].substring(2))+5),i.join(",")}),l.selectAll(".nonSeqPath").attr("d",function(t){var n=e.line(t.pathRange),i=n.split(",");return parseFloat(i[0].substring(1))>0&&(i[0]="M"+(parseFloat(i[0].substring(1))+5)),i[1]="0L"+(parseFloat(i[1].substring(2))-5),i.join(",")});var n=l.selectAll(".linePathEle");n.each(function(){t.select(t.select(this).node()).attr("d",function(t){var n=e.line(t.pathRange),i=n.split(","),o=parseFloat(i[0].substring(1))+5,r=i.length;i[0]="M"+o;var a=parseFloat(i[r-2].substring(2))-5;return i[r-2]="5L"+a,i.join(",")})}),l.selectAll(".seqAxis").style("display","block"),l.selectAll(".hideTextOnZoom").style("display","none"),l.selectAll(".showTextOnZoom").style("display","block")}else l.selectAll(".seqAxis").style("display","none"),l.selectAll(".hideTextOnZoom").style("display","block"),l.selectAll(".showTextOnZoom").style("display","none")},o.prototype.zoomDraw=function(){var e=this;e.zoom.scale()>1?l.selectAll(".SeqScrollArrow").style("display","block"):l.selectAll(".SeqScrollArrow").style("display","none"),a.allowZoom===!1&&e.zoom.scale(e.scaleConfig.maxZoom);var n=e.zoom.translate(),i=e.zoom.scale(),o=Math.min(0,Math.max(v.svgScaleWidth*(1-i),n[0])),r=Math.min(0,Math.max(1*(1-i),n[1]));e.zoom.translate([o,r]),g.select("g.x.axis").call(e.xAxis),l.selectAll(".pathEle").each(function(n){t.select(this).attr("d",e.line(n.pathRange))}),l.selectAll(".arrowEle").each(function(n){t.select(this).attr("d",e.getArrowDVal(e.line(n.pathRange)))}),l.selectAll(".linkerPathEle").each(function(n){var i=e.getZigZagdVal(e.xScale(n.pathStart),n.pathPosition);t.select(t.select(this).node()).attr("d",i)}),l.selectAll(".seqAxis").call(e.seqAxis);for(var s in e.shapeMaster)l.selectAll("."+s).attr("d",e.getShapeDVal(e.shapeMaster[s])).attr("transform",function(t){var n="translate("+e.xScale(t.residue_number-1)+",10)";return"undefined"!=typeof t.marginTop&&0!==t.marginTop&&(n="translate("+e.xScale(t.residue_number-1)+","+t.marginTop+")"),n});e.displaySeq(),l.selectAll(".textEle").each(function(){var n=t.select(this),i=n.data()[0];n.attr("x",function(t){return e.xScale(t.textRange[0][0])}),"undefined"!=typeof i&&"undefined"!=typeof i.fitInPath&&i.fitInPath===!0&&(n.style("font-size","12px"),e.fitTextInPath(n))})},o.prototype.initFitTextInPath=function(){var e=this;l.selectAll(".fitTextInPath").each(function(){var n=t.select(this),i=n.data()[0];n.style("display","block"),n.attr("x",function(t){return e.xScale(t.textRange[0][0])}),"undefined"!=typeof i&&"undefined"!=typeof i.fitInPath&&i.fitInPath===!0&&e.fitTextInPath(n)})},o.prototype.showTooltip=function(e,n,i){var o=0,r=0;"ng"===n?(r=i.pageX,o=i.pageY):(r=t.event.pageX,o=t.event.pageY),b.html(e).style("display","block").style("top",o+15+"px").style("left",r+10+"px")},o.prototype.hideTooltip=function(){b.style("display","none")},o.prototype.getResidue=function(t,e){var n=this,i=t[0];return"circle"!==e&&(i=Math.round(n.xScale.invert(t[0]))),"Residue "+(i+1)+" ("+n.sequenceArr[i]+")"},o.prototype.dispatchEvent=function(t,e,n){var i=s[0];"undefined"!=typeof n&&(i=n),"undefined"!=typeof e&&(a.pdbevents[t].eventData=e),i.dispatchEvent(a.pdbevents[t])},o.prototype.eventOperations=function(t,e,n,i,o,r){var s,p,l=this;"undefined"!=typeof r&&(s=r.tooltipMsg,p=r.tooltipPosition),"circle"===n&&(o[0]=r.residue_number-1);var u=l.getResidue(o,n);angular.isUndefined(s)?s=u:angular.isUndefined(p)||"prefix"!==p?angular.isUndefined(p)||"postfix"!==p||(s=u+" "+s):s=s+" "+u,"PDB.uniprotViewer.mouseover"==t&&l.showTooltip(s,"d3",o),l.dispatchEvent(t,{viewerType:"pdbViewer",elementData:r,residueNumber:parseInt(u.split(" ")[1]),entryId:a.entryId})},o.prototype.attachMouseEvent=function(e,n,i,o){var r=this;e.on("click",function(){var a=t.mouse(this);r.eventOperations("PDB.uniprotViewer.click",e,n,i,a,o)}).on("mouseover",function(){var a=t.mouse(this);r.eventOperations("PDB.uniprotViewer.mouseover",e,n,i,a,o)}).on("mousemove",function(){var a=t.mouse(this);r.eventOperations("PDB.uniprotViewer.mouseover",e,n,i,a,o)}).on("mouseleave",function(){r.hideTooltip(),r.dispatchEvent("PDB.uniprotViewer.mouseout",{viewerType:"pdbViewer",entryId:a.entryId})})},o}(),y=new w;a.$watch("activeViewBtn",function(){"undefined"!=typeof y.zoom&&("expanded"===a.activeViewBtn?(y.zoom.scale(y.scaleConfig.maxZoom),y.zoomDraw(),a.allowZoom=!1):(y.zoom.scale(1),a.allowZoom=!0,y.zoomDraw()))});var x;a.movePan=function(t){var e=y.zoom.translate();y.zoom.translate([e[0]+t,e[1]]),y.zoomDraw(),x=o(function(){var e=y.zoom.translate();y.zoom.translate([e[0]+t,e[1]]),y.zoomDraw()},100)},a.stopMovingPan=function(){o.cancel(x)},a.showTooltip=function(t,e,n){y.showTooltip(t,e,n)},a.hideTooltip=function(){y.hideTooltip()}}}}])}();